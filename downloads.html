<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Downloads | Merlin Custom Works</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="bg-logo"></div>

  <header class="site-header">
    <a href="index.html" class="site-title">Merlin Custom Works</a>
    <nav class="site-nav">
      <a href="index.html">Home</a>
      <a href="mods.html">Mods</a>
      <a href="commissions.html">Commissions</a>
      <a href="downloads.html" class="active">Downloads</a>
      <a href="contact.html">Contact</a>
      <a href="downloads.html">Patron Downloads</a>
    </nav>
  </header>

  <section class="hero">
    <h2>Downloads</h2>
    <p>Patreon content. Enter your access code to unlock downloads.</p>
  </section>

  <!-- Access Bar -->
  <section class="download-access">
    <div class="access-row">
      <input id="accessCode" type="text" placeholder="Enter access code…" aria-label="Access code">
      <button id="unlockBtn" type="button">Unlock</button>
      <span id="accessStatus" class="meta"></span>
    </div>
    <p class="meta">Get your code in Discord using <strong>/mcwaccess</strong>.</p>
  </section>

  <!-- Search / Filters (shown after unlock) -->
  <section class="mod-filters" id="downloadFilters" style="display:none;">
    <input type="text" id="downloadSearch" placeholder="Search downloads…" aria-label="Search downloads">
    <div class="filter-buttons">
      <button data-filter="all" class="active">All</button>
      <button data-filter="engine">Engine</button>
      <button data-filter="wheels">Wheels</button>
      <button data-filter="car">Cars</button>
      <button data-filter="released">Released</button>
      <button data-filter="wip">WIP</button>
    </div>
  </section>

  <!-- Locked state -->
  <section id="lockedState">
    <div class="card">
      <p><strong>Locked.</strong> Enter your access code from Discord to view and download Patreon content.</p>
      <p class="meta">Tip: If you didn’t receive a DM, enable DMs from server members and run <strong>/mcwaccess</strong> again.</p>
    </div>
  </section>

  <!-- Downloads grid -->
  <section id="downloadsSection" style="display:none;">
    <div class="grid" id="downloadsGrid"></div>
  </section>

  <footer>
    <p>© Merlin Custom Works</p>
  </footer>

  <button class="back-to-top" type="button" aria-label="Back to top">↑</button>

  <script>
    // ===== CONFIG =====
    // Put your Cloudflare Worker URL here (NO trailing slash)
    const API_BASE = "https://mcw-access.YOURNAME.workers.dev";

    // Edit this list as you add releases
    // fileKey MUST match the object name/key in R2 exactly
    const DOWNLOADS = [
      {
        id: "holden-hsv-wheel-pack",
        title: "Holden/HSV Wheel and Hubcap Pack",
        status: "released",
        category: "wheels",
        version: "v1.5",
        tier: "Legend",
        images: ["images/wheelpack1.jpg", "images/wheelpack2.jpg"],
        bullets: [
          "VN–VF wheel set",
          "Hubcaps included",
          "Custom 3D models",
          "Regular updates"
        ],
        fileKey: "holden-hsv-wheel-pack_v1.5.zip"
      },
      {
        id: "cfw-vn-engine-pack",
        title: "CFW VN Engine Pack",
        status: "released",
        category: "engine",
        version: "v0.5",
        tier: "Legend",
        images: ["images/vn-sedan-ls.jpg", "images/vn-sedan-ls2.jpg", "images/vn-sedan-ls3.jpg"],
        bullets: [
          "LS1 5.7L + LS2 6.0L configs",
          "Turbo kits / headers / intakes",
          "Internal parts + camshafts",
          "Realistic behaviour tuning"
        ],
        fileKey: "cfw-vn-engine-pack_v0.5.zip"
      },
      {
        id: "240z-wip",
        title: "240Z Project (WIP)",
        status: "wip",
        category: "car",
        version: "WIP",
        tier: "Legend",
        images: ["images/240z-wip.jpg"],
        bullets: [
          "In-development build",
          "Progress snapshots + test builds",
          "Changes frequently"
        ],
        fileKey: "240z_wip_latest.zip"
      }
    ];

    // ===== Elements =====
    const downloadsGrid = document.getElementById("downloadsGrid");
    const lockedState = document.getElementById("lockedState");
    const downloadsSection = document.getElementById("downloadsSection");
    const downloadFilters = document.getElementById("downloadFilters");
    const codeInput = document.getElementById("accessCode");
    const unlockBtn = document.getElementById("unlockBtn");
    const accessStatus = document.getElementById("accessStatus");

    // ===== Render cards =====
    function createCarouselHTML(images) {
      if (!images || images.length === 0) return `<div class="placeholder-img"></div>`;

      const imgs = images.map((src, i) =>
        `<img class="carousel-slide" src="${src}" alt="Screenshot ${i+1}" loading="lazy">`
      ).join("");

      return `
        <div class="carousel" data-carousel>
          <div class="carousel-track is-loading">${imgs}</div>
          <button class="carousel-btn prev" type="button" aria-label="Previous image">‹</button>
          <button class="carousel-btn next" type="button" aria-label="Next image">›</button>
          <div class="carousel-dots"></div>
        </div>
      `;
    }

    function renderCards(list) {
      downloadsGrid.innerHTML = "";
      list.forEach(mod => {
        const card = document.createElement("div");
        card.className = "card" + (mod.status === "wip" ? " card-wip" : "");
        card.dataset.category = mod.category;
        card.dataset.status = mod.status;

        card.innerHTML = `
          ${createCarouselHTML(mod.images)}
          <div class="card-top">
            <h3>${mod.title}</h3>
            <div class="badges">
              <span class="badge ${mod.status === "released" ? "badge-released" : ""}">${mod.status.toUpperCase()}</span>
              <span class="badge">${mod.version}</span>
            </div>
          </div>

          <p class="meta"><strong>Tier:</strong> ${mod.tier}</p>

          <ul>
            ${mod.bullets.map(b => `<li>${b}</li>`).join("")}
          </ul>

          <div class="links">
            <a class="icon-btn" href="${API_BASE}/download/${encodeURIComponent(mod.fileKey)}" title="Download" aria-label="Download">
              ⬇
            </a>
          </div>
        `;
        downloadsGrid.appendChild(card);
      });

      setupCarousels();
    }

    // ===== Carousel logic =====
    function setupCarousels() {
      document.querySelectorAll('[data-carousel]').forEach((carousel) => {
        const track = carousel.querySelector('.carousel-track');
        const slides = Array.from(carousel.querySelectorAll('.carousel-slide'));
        const prevBtn = carousel.querySelector('.carousel-btn.prev');
        const nextBtn = carousel.querySelector('.carousel-btn.next');
        const dotsWrap = carousel.querySelector('.carousel-dots');

        if (!track || slides.length === 0) return;

        dotsWrap.innerHTML = "";
        const dots = slides.map((_, i) => {
          const d = document.createElement('div');
          d.className = 'carousel-dot' + (i === 0 ? ' active' : '');
          d.addEventListener('click', () => goTo(i));
          dotsWrap.appendChild(d);
          return d;
        });

        let index = 0;

        function update() {
          track.style.transform = `translateX(${-index * 100}%)`;
          dots.forEach((d, i) => d.classList.toggle('active', i === index));
        }
        function goTo(i) {
          index = (i + slides.length) % slides.length;
          update();
        }

        prevBtn?.addEventListener('click', () => goTo(index - 1));
        nextBtn?.addEventListener('click', () => goTo(index + 1));

        const first = slides[0];
        if (first.complete) track.classList.remove('is-loading');
        else first.addEventListener('load', () => track.classList.remove('is-loading'), { once: true });

        if (slides.length === 1) {
          prevBtn.style.display = "none";
          nextBtn.style.display = "none";
          dotsWrap.style.display = "none";
        }
      });
    }

    // ===== Unlock flow =====
    async function verifyCode(code) {
      const res = await fetch(`${API_BASE}/verify`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ code })
      });
      if (!res.ok) throw new Error("Invalid/expired");
      return res.json();
    }

    function setUnlockedUI(tier) {
      lockedState.style.display = "none";
      downloadsSection.style.display = "";
      downloadFilters.style.display = "";
      accessStatus.textContent = `Unlocked: ${tier}`;
      renderCards(DOWNLOADS);
    }

    unlockBtn.addEventListener("click", async () => {
      const code = codeInput.value.trim();
      if (!code) return;

      accessStatus.textContent = "Checking…";
      try {
        const data = await verifyCode(code);
        setUnlockedUI(data.tier || "Access");
      } catch {
        accessStatus.textContent = "Invalid/expired code.";
      }
    });

    // ===== Filters/Search =====
    const searchInput = document.getElementById("downloadSearch");
    const filterButtons = document.querySelectorAll(".filter-buttons button");
    let activeFilter = "all";

    function applyFilters() {
      const query = (searchInput?.value || "").toLowerCase();
      document.querySelectorAll("#downloadsGrid .card").forEach(card => {
        const title = card.querySelector("h3")?.textContent.toLowerCase() || "";
        const category = card.dataset.category;
        const status = card.dataset.status;

        const matchesSearch = title.includes(query);
        const matchesFilter = activeFilter === "all" || category === activeFilter || status === activeFilter;

        card.style.display = (matchesSearch && matchesFilter) ? "" : "none";
      });
    }

    searchInput?.addEventListener("input", applyFilters);
    filterButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        filterButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter = btn.dataset.filter;
        applyFilters();
      });
    });

    // ===== Back to top =====
    const backBtn = document.querySelector(".back-to-top");
    function toggleBackToTop() {
      if (!backBtn) return;
      if (window.scrollY > 500) backBtn.classList.add("show");
      else backBtn.classList.remove("show");
    }
    window.addEventListener("scroll", toggleBackToTop, { passive: true });
    toggleBackToTop();
    backBtn?.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
  </script>

</body>
</html>
